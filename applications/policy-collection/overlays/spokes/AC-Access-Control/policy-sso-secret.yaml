---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: sso-secret-spokes
  namespace: openshift-gitops
spec:
  refreshInterval: "60s"
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: sso-secret-spokes
    manifest:
      apiVersion: policy.open-cluster-management.io/v1
      kind: Policy  
    template:
      engineVersion: v2
      mergePolicy: Merge
      metadata:
        annotations:
          policy.open-cluster-management.io/categories: AC Access Control
          policy.open-cluster-management.io/controls: AC-3 Access Enforcement
          policy.open-cluster-management.io/standards: NIST SP 800-53
        labels:
          requires-rolling-restart: none
      templateFrom:
      - literal: |
          disabled: false
          policy-templates:
          - objectDefinition:
              apiVersion: policy.open-cluster-management.io/v1
              kind: ConfigurationPolicy
              metadata:
                name: sso-secret-spokes
              spec:
                object-templates:
                  - complianceType: musthave
                    objectDefinition:
                      kind: Secret
                      apiVersion: v1
                      stringData:
                        CLIENT_ID: {{.clientId}}
                        CLIENT_SECRET: {{.clientSecret}}
                        KEYCLOAK_URL: {{.keycloakUrl}}
                      metadata:
                        name: openid-client-secret
                        namespace: openshift-config
                      type: Opaque
                remediationAction: inform
                severity: low
          remediationAction: enforce
        target: spec
  data:
  - secretKey: clientSecret
    remoteRef:
      key: kv/data/ocp/sno/openshift-gitops/policies
      property: CLIENT_ID
  - secretKey: clientId
    remoteRef:
      key: kv/data/ocp/sno/openshift-gitops/policies
      property: CLIENT_SECRET
  - secretKey: keycloakUrl
    remoteRef:
      key: kv/data/ocp/sno/openshift-gitops/policies
      property: KEYCLOAK_URL
